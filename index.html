<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم جامع تحلیل و معامله‌گری بازارهای مالی ایران</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #1e3c72;
            --secondary: #2a5298;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --sidebar-width: 280px;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(255, 255, 255, 0.95);
            height: 100vh;
            position: fixed;
            right: 0;
            top: 0;
            padding: 20px;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 1000;
        }
        
        .main-content {
            flex: 1;
            margin-right: var(--sidebar-width);
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            font-size: 1.6rem;
            font-weight: 600;
        }
        
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .market-item {
            background: var(--light);
            border-radius: 12px;
            padding: 18px;
            border-left: 5px solid var(--primary);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .market-item:hover {
            background: #e9ecef;
            transform: translateX(8px);
        }
        
        .market-name {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .market-price {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        .market-change {
            font-size: 0.95rem;
            padding: 5px 12px;
            border-radius: 8px;
            display: inline-block;
            font-weight: 600;
        }
        
        .positive {
            background: #d4edda;
            color: #155724;
        }
        
        .negative {
            background: #f8d7da;
            color: #721c24;
        }
        
        .chart-container {
            height: 400px;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .control-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        select, button, input {
            padding: 12px 18px;
            border-radius: 10px;
            border: 1px solid #ddd;
            background: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        select:focus, button:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.2);
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .analysis-section {
            margin-top: 25px;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .analysis-item {
            background: var(--light);
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid var(--success);
            transition: all 0.3s ease;
        }
        
        .risk-item {
            border-left-color: var(--danger);
        }
        
        .opportunity-item {
            border-left-color: var(--success);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
        }
        
        .status-active {
            background: var(--success);
        }
        
        .status-inactive {
            background: var(--danger);
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .feature-item {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .feature-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .feature-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .sidebar-section {
            margin-bottom: 30px;
        }
        
        .sidebar-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .model-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .model-status.active {
            border-right: 4px solid var(--success);
        }
        
        .model-status.inactive {
            border-right: 4px solid var(--danger);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: calc(var(--sidebar-width) + 20px);
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .close-notification {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }
        
        .technical-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .indicator {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .indicator-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .indicator-name {
            font-size: 0.9rem;
            color: #666;
        }
        
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                width: 250px;
            }
            
            .main-content {
                margin-right: 250px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-right: 0;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .control-group {
                width: 100%;
                justify-content: center;
            }
            
            select, button {
                flex: 1;
                min-width: 150px;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
        
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }
        }
        
        .risk-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .metric {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.4rem;
            font-weight: bold;
        }
        
        .metric-high {
            color: var(--danger);
        }
        
        .metric-medium {
            color: var(--warning);
        }
        
        .metric-low {
            color: var(--success);
        }
    </style>
</head>
<body>
    <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-section">
            <h3>وضعیت مدل‌های هوش مصنوعی</h3>
            <div class="model-status active">
                <span>AdvancedDecisionExplainer</span>
                <span class="status-indicator status-active"></span>
            </div>
            <div class="model-status active">
                <span>MarketSentimentTransformer</span>
                <span class="status-indicator status-active"></span>
            </div>
            <div class="model-status active">
                <span>PricePredictionTransformer</span>
                <span class="status-indicator status-active"></span>
            </div>
            <div class="model-status active">
                <span>RiskAssessorAgent</span>
                <span class="status-indicator status-active"></span>
            </div>
        </div>
        
        <div class="sidebar-section">
            <h3>اندیکاتورهای فنی</h3>
            <div class="technical-indicators" id="technicalIndicators">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="sidebar-section">
            <h3>معیارهای ریسک</h3>
            <div class="risk-metrics" id="riskMetrics">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="sidebar-section">
            <h3>سیستم‌های فعال</h3>
            <div class="model-status active">
                <span>SHAP Explanation</span>
                <span class="status-indicator status-active"></span>
            </div>
            <div class="model-status active">
                <span>LIME Analysis</span>
                <span class="status-indicator status-active"></span>
            </div>
            <div class="model-status active">
                <span>Feature Importance</span>
                <span class="status-indicator status-active"></span>
            </div>
            <div class="model-status active">
                <span>Counterfactual Analysis</span>
                <span class="status-indicator status-active"></span>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="container">
            <header>
                <h1>سیستم جامع تحلیل و معامله‌گری بازارهای مالی ایران</h1>
                <p class="subtitle">تحلیل یکپارچه بورس، ارز دیجیتال، طلا و ارز با هوش مصنوعی پیشرفته</p>
            </header>
            
            <div class="controls">
                <div class="control-group">
                    <select id="marketType">
                        <option value="all">همه بازارها</option>
                        <option value="stock">بورس اوراق بهادار</option>
                        <option value="crypto">ارز دیجیتال</option>
                        <option value="gold">طلا و سکه</option>
                        <option value="currency">ارز</option>
                        <option value="commodity">کامودیتی</option>
                    </select>
                    
                    <select id="timeFrame">
                        <option value="1d">۱ روز</option>
                        <option value="1w">۱ هفته</option>
                        <option value="1m">۱ ماه</option>
                        <option value="3m">۳ ماه</option>
                        <option value="1y">۱ سال</option>
                    </select>
                    
                    <button id="refreshBtn">
                        <span>🔄</span> بروزرسانی داده‌ها
                    </button>
                </div>
                
                <div class="control-group">
                    <button id="analyzeBtn">
                        <span>🤖</span> تحلیل هوش مصنوعی
                    </button>
                    <button id="riskBtn">
                        <span>⚠️</span> ارزیابی ریسک
                    </button>
                    <button id="tradeBtn">
                        <span>💼</span> پیشنهاد معامله
                    </button>
                    <button id="explainBtn">
                        <span>🔍</span> توضیح تصمیمات
                    </button>
                </div>
            </div>
            
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="dashboard">داشبورد اصلی</div>
                    <div class="tab" data-tab="analysis">تحلیل پیشرفته</div>
                    <div class="tab" data-tab="explanations">توضیح‌پذیری AI</div>
                    <div class="tab" data-tab="trading">معاملات</div>
                    <div class="tab" data-tab="reports">گزارش‌ها</div>
                    <div class="tab" data-tab="transformer">مدل‌های Transformer</div>
                </div>
                
                <div class="tab-content active" id="dashboard-tab">
                    <div class="dashboard">
                        <div class="card">
                            <h2>وضعیت بازارها</h2>
                            <div class="market-grid" id="marketStatus">
                                <div class="loading">در حال بارگذاری داده‌های بازار...</div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h2>شاخص‌های کلان</h2>
                            <div id="indicesChart" class="chart-container"></div>
                        </div>
                        
                        <div class="card">
                            <h2>تحلیل قیمت و روند</h2>
                            <div id="priceChart" class="chart-container"></div>
                        </div>
                        
                        <div class="card">
                            <h2>تحلیل تکنیکال پیشرفته</h2>
                            <div id="technicalChart" class="chart-container"></div>
                        </div>
                    </div>
                    
                    <div class="card analysis-section">
                        <h2>تحلیل هوش مصنوعی و پیشنهادات معاملاتی</h2>
                        <div class="analysis-grid" id="aiAnalysis">
                            <div class="loading">برای مشاهده تحلیل‌ها، دکمه "تحلیل هوش مصنوعی" را بفشارید</div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="analysis-tab">
                    <div class="card">
                        <h2>تحلیل پیشرفته بازار</h2>
                        <div class="feature-grid">
                            <div class="feature-item">
                                <div class="feature-icon">📊</div>
                                <h3>تحلیل تکنیکال</h3>
                                <p>اندیکاتورهای پیشرفته و سیگنال‌های معاملاتی</p>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">📈</div>
                                <h3>تحلیل بنیادی</h3>
                                <p>ارزیابی ارزش ذاتی و پتانسیل رشد</p>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">🧠</div>
                                <h3>هوش مصنوعی</h3>
                                <p>پیش‌بینی روند با مدل‌های Transformer</p>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">📉</div>
                                <h3>تحلیل احساسات</h3>
                                <p>بررسی جو بازار و تأثیر اخبار</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>گزارش تحلیل بازار</h2>
                        <div id="advancedAnalysis" class="analysis-grid">
                            <div class="loading">در حال محاسبه تحلیل‌های پیشرفته...</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>تحلیل ویژگی‌های مهم</h2>
                        <div id="featureImportanceChart" class="chart-container"></div>
                    </div>
                </div>
                
                <div class="tab-content" id="explanations-tab">
                    <div class="card">
                        <h2>توضیح‌پذیری هوش مصنوعی (XAI)</h2>
                        <div class="analysis-grid" id="xaiExplanations">
                            <div class="loading">در حال تولید توضیحات هوش مصنوعی...</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>تحلیل SHAP</h2>
                        <div id="shapChart" class="chart-container"></div>
                    </div>
                    
                    <div class="card">
                        <h2>تحلیل LIME</h2>
                        <div id="limeChart" class="chart-container"></div>
                    </div>
                </div>
                
                <div class="tab-content" id="trading-tab">
                    <div class="card">
                        <h2>سیستم معاملاتی هوشمند</h2>
                        <div class="analysis-grid">
                            <div class="analysis-item opportunity-item">
                                <h3>پیشنهاد خرید</h3>
                                <p><strong>نماد:</strong> شتران</p>
                                <p><strong>قیمت هدف:</strong> ۵۲,۰۰۰ تومان</p>
                                <p><strong>حد ضرر:</strong> ۴۲,۰۰۰ تومان</p>
                                <div class="market-change positive">اعتماد: ۷۸%</div>
                            </div>
                            <div class="analysis-item opportunity-item">
                                <h3>پیشنهاد خرید</h3>
                                <p><strong>نماد:</strong> بیت‌کوین</p>
                                <p><strong>قیمت هدف:</strong> ۹۵,۰۰۰ دلار</p>
                                <p><strong>حد ضرر:</strong> ۷۸,۰۰۰ دلار</p>
                                <div class="market-change positive">اعتماد: ۸۲%</div>
                            </div>
                            <div class="analysis-item risk-item">
                                <h3>هشدار فروش</h3>
                                <p><strong>نماد:</strong> سکه امامی</p>
                                <p><strong>دلیل:</strong> رسیدن به محدوده اشباع خرید</p>
                                <p><strong>توصیه:</strong> کاهش موقعیت</p>
                                <div class="market-change negative">ریسک: بالا</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>تحلیل سناریوهای متغیر</h2>
                        <div id="counterfactualChart" class="chart-container"></div>
                    </div>
                </div>
                
                <div class="tab-content" id="reports-tab">
                    <div class="card">
                        <h2>گزارش‌های عملکرد</h2>
                        <div class="analysis-grid">
                            <div class="analysis-item">
                                <h3>عملکرد پرتفوی</h3>
                                <p><strong>سود/زیان کل:</strong> +۱۲.۵%</p>
                                <p><strong>بهترین عملکرد:</strong> بورس (+۱۸.۲%)</p>
                                <p><strong>ضعیف‌ترین عملکرد:</strong> ارز دیجیتال (+۵.۸%)</p>
                            </div>
                            <div class="analysis-item">
                                <h3>تحلیل ریسک</h3>
                                <p><strong>VaR 95%:</strong> -۳.۲%</p>
                                <p><strong>حداکثر افت:</strong> -۸.۵%</p>
                                <p><strong>نسبت شارپ:</strong> ۱.۴۵</p>
                            </div>
                            <div class="analysis-item">
                                <h3>گزارش معاملات</h3>
                                <p><strong>تعداد معاملات:</strong> ۴۷</p>
                                <p><strong>میانگین سود:</strong> +۴.۲%</p>
                                <p><strong>نرخ موفقیت:</strong> ۶۸%</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="transformer-tab">
                    <div class="card">
                        <h2>مدل‌های Transformer پیشرفته</h2>
                        <div class="analysis-grid">
                            <div class="analysis-item">
                                <h3>MarketSentimentTransformer</h3>
                                <p><strong>معماری:</strong> BERT-base + Attention Layers</p>
                                <p><strong>دقت:</strong> ۸۷.۳%</p>
                                <p><strong>کاربرد:</strong> تحلیل احساسات بازار</p>
                            </div>
                            <div class="analysis-item">
                                <h3>PricePredictionTransformer</h3>
                                <p><strong>معماری:</strong> Multi-Scale Attention</p>
                                <p><strong>دقت:</strong> ۷۹.۸%</p>
                                <p><strong>کاربرد:</strong> پیش‌بینی قیمت</p>
                            </div>
                            <div class="analysis-item">
                                <h3>TimeSeriesTransformer</h3>
                                <p><strong>معماری:</strong> Positional Encoding</p>
                                <p><strong>دقت:</strong> ۸۲.۱%</p>
                                <p><strong>کاربرد:</strong> تحلیل سری زمانی</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>پیش‌بینی‌های Transformer</h2>
                        <div id="transformerPredictionsChart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===============================
        // API endpoints and configuration
        // ===============================
                       const API_ENDPOINTS = {
            stockSymbols: 'https://BrsApi.ir/Api/Tsetmc/AllSymbols.php?key=BKNzfpdXhJMcUANBeAAcNT24Cdys8MES',
            stockIndex: 'https://BrsApi.ir/Api/Tsetmc/Index.php?key=BKNzfpdXhJMcUANBeAAcNT24Cdys8MES&type=1',
            farabourseIndex: 'https://BrsApi.ir/Api/Tsetmc/Index.php?key=BKNzfpdXhJMcUANBeAAcNT24Cdys8MES&type=2',
            selectedIndex: 'https://BrsApi.ir/Api/Tsetmc/Index.php?key=BKNzfpdXhJMcUANBeAAcNT24Cdys8MES&type=1',
            crypto: 'https://BrsApi.ir/Api/Market/Cryptocurrency.php?key=BKNzfpdXhJMcUANBeAAcNT24Cdys8MES',
            commodityMetals: 'https://BrsApi.ir/Api/Market/Commodity.php?key=BKNzfpdXhJMcUANBeAAcNT24Cdys8MES&type=1',
            commodityBaseMetals: 'https://BrsApi.ir/Api/Market/Commodity.php?key=BKNzfpdXhJMcUANBeAAcNT24Cdys8MES&type=2',
            commodityEnergy: 'https://BrsApi.ir/Api/Market/Commodity.php?key=BKNzfpdXhJMcUANBeAAcNT24Cdys8MES&type=3',
            gold: 'https://BrsApi.ir/Api/Market/Gold_Currency.php?key=BKNzfpdXhJMcUANBeAAcNT24Cdys8MES&type=1',
            currency: 'https://BrsApi.ir/Api/Market/Gold_Currency.php?key=BKNzfpdXhJMcUANBeAAcNT24Cdys8MES&type=2',
            crypto2: 'https://BrsApi.ir/Api/Market/Gold_Currency.php?key=BKNzfpdXhJMcUANBeAAcNT24Cdys8MES&type=3'
        };

        const API_NAMES = {
            stockSymbols: 'نمادهای بورس',
            stockIndex: 'شاخص بورس',
            farabourseIndex: 'شاخص فرابورس',
            selectedIndex: 'شاخص منتخب',
            crypto: 'ارز دیجیتال',
            commodityMetals: 'فلزات گرانبها',
            commodityBaseMetals: 'فلزات اساسی',
            commodityEnergy: 'انرژی',
            gold: 'طلا و سکه',
            currency: 'ارز',
            crypto2: 'ارز دیجیتال (منبع ۲)'
        };

        // ===============================
        // سیستم نظارت هوشمند
        // ===============================
        class APIMonitoringSystem {
            constructor() {
                this.apiStatus = {};
                this.connectionHistory = [];
                this.alerts = [];
                this.monitoringInterval = null;
                this.isMonitoring = false;
                
                this.initializeMonitoring();
            }

            initializeMonitoring() {
                // مقداردهی اولیه وضعیت همه APIها
                for (const [key, url] of Object.entries(API_ENDPOINTS)) {
                    this.apiStatus[key] = {
                        name: API_NAMES[key],
                        url: url,
                        status: 'unknown',
                        lastCheck: null,
                        responseTime: null,
                        successRate: 0,
                        errorCount: 0,
                        successCount: 0,
                        lastError: null,
                        shouldBeActive: this.shouldAPIBeActive(key)
                    };
                }
            }

            // بررسی ساعات کاری APIها
            shouldAPIBeActive(apiKey) {
                const tehranTime = this.getTehranTime();
                const hour = tehranTime.getHours();
                const minute = tehranTime.getMinutes();
                const day = tehranTime.getDay();
                
                // APIهای بورس فقط در ساعات کاری فعال هستند
                if (apiKey.includes('stock') || apiKey.includes('Index')) {
                    if (day >= 5) return false; // جمعه و شنبه
                    if (hour < 9 || hour > 12) return false;
                    if (hour === 12 && minute > 30) return false;
                }
                
                return true;
            }

            getTehranTime() {
                const now = new Date();
                const tehranOffset = 3.5 * 60 * 60 * 1000; // UTC+3:30
                return new Date(now.getTime() + tehranOffset);
            }

            // شروع نظارت خودکار
            startAutoMonitoring() {
                if (this.monitoringInterval) {
                    clearInterval(this.monitoringInterval);
                }
                
                this.isMonitoring = true;
                this.monitoringInterval = setInterval(() => {
                    this.checkAllAPIs();
                }, 60000); // هر 1 دقیقه
                
                // اولین بررسی فوری
                this.checkAllAPIs();
                
                showNotification('سیستم نظارت خودکار APIها فعال شد', 'success');
            }

            // توقف نظارت
            stopAutoMonitoring() {
                if (this.monitoringInterval) {
                    clearInterval(this.monitoringInterval);
                    this.monitoringInterval = null;
                }
                this.isMonitoring = false;
                showNotification('سیستم نظارت خودکار متوقف شد', 'warning');
            }

            // بررسی وضعیت همه APIها
            async checkAllAPIs() {
                const promises = [];
                
                for (const [key, apiInfo] of Object.entries(this.apiStatus)) {
                    promises.push(this.checkSingleAPI(key, apiInfo));
                }
                
                await Promise.all(promises);
                this.updateMonitoringDisplay();
                this.updateConnectionChart();
            }

            // بررسی وضعیت یک API خاص
            async checkSingleAPI(apiKey, apiInfo) {
                // به‌روزرسانی وضعیت ساعات کاری
                apiInfo.shouldBeActive = this.shouldAPIBeActive(apiKey);
                
                if (!apiInfo.shouldBeActive) {
                    apiInfo.status = 'inactive_hours';
                    apiInfo.lastCheck = new Date();
                    return;
                }

                try {
                    const startTime = Date.now();
                    const response = await axios.get(apiInfo.url, {
                        timeout: 10000,
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const responseTime = Date.now() - startTime;
                    
                    // ثبت موفقیت
                    apiInfo.status = 'connected';
                    apiInfo.lastCheck = new Date();
                    apiInfo.responseTime = responseTime;
                    apiInfo.successCount++;
                    apiInfo.lastError = null;
                    
                    // محاسبه نرخ موفقیت
                    const totalRequests = apiInfo.successCount + apiInfo.errorCount;
                    apiInfo.successRate = totalRequests > 0 ? (apiInfo.successCount / totalRequests) * 100 : 0;
                    
                    // ثبت در تاریخچه
                    this.connectionHistory.push({
                        api: apiKey,
                        timestamp: new Date(),
                        status: 'success',
                        responseTime: responseTime
                    });
                    
                } catch (error) {
                    // ثبت خطا
                    apiInfo.status = 'disconnected';
                    apiInfo.lastCheck = new Date();
                    apiInfo.errorCount++;
                    apiInfo.lastError = error.message;
                    
                    // محاسبه نرخ موفقیت
                    const totalRequests = apiInfo.successCount + apiInfo.errorCount;
                    apiInfo.successRate = totalRequests > 0 ? (apiInfo.successCount / totalRequests) * 100 : 0;
                    
                    // ثبت در تاریخچه
                    this.connectionHistory.push({
                        api: apiKey,
                        timestamp: new Date(),
                        status: 'error',
                        error: error.message
                    });
                    
                    // ارسال هشدار
                    this.sendAlert(apiKey, `قطع ارتباط با ${apiInfo.name}`, error.message);
                }
            }

            // ارسال هشدار
            sendAlert(apiKey, title, message) {
                const alert = {
                    id: Date.now(),
                    apiKey: apiKey,
                    apiName: API_NAMES[apiKey],
                    title: title,
                    message: message,
                    timestamp: new Date(),
                    read: false
                };
                
                this.alerts.unshift(alert);
                
                // نمایش نوتیفیکیشن
                showNotification(`🚨 ${title}: ${message}`, 'error');
                
                // پخش صدای هشدار (در صورت نیاز)
                this.playAlertSound();
                
                // حفظ هشدارها (حداکثر 50 مورد)
                if (this.alerts.length > 50) {
                    this.alerts = this.alerts.slice(0, 50);
                }
                
                this.updateAlertsDisplay();
            }

            playAlertSound() {
                // ایجاد صدای هشدار ساده
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch (error) {
                    console.log('امکان پخش صدا وجود ندارد');
                }
            }

            // به‌روزرسانی نمایش وضعیت
            updateMonitoringDisplay() {
                this.updateSidebarStatus();
                this.updateLiveMonitoring();
                this.updatePerformanceStats();
                this.updateConnectionStats();
            }

            // به‌روزرسانی وضعیت در sidebar
            updateSidebarStatus() {
                const container = document.getElementById('apiStatusContainer');
                let html = '';
                
                for (const [key, apiInfo] of Object.entries(this.apiStatus)) {
                    let statusClass = 'api-status ';
                    let statusText = '';
                    let indicatorClass = '';
                    
                    if (!apiInfo.shouldBeActive) {
                        statusClass += 'warning';
                        statusText = '⏸ غیرفعال (ساعات کاری)';
                        indicatorClass = 'status-warning';
                    } else if (apiInfo.status === 'connected') {
                        statusClass += 'connected';
                        statusText = `✅ متصل (${apiInfo.responseTime}ms)`;
                        indicatorClass = 'status-connected';
                    } else if (apiInfo.status === 'disconnected') {
                        statusClass += 'disconnected';
                        statusText = '❌ قطع ارتباط';
                        indicatorClass = 'status-disconnected';
                    } else {
                        statusClass += 'warning';
                        statusText = '🔍 در حال بررسی...';
                        indicatorClass = 'status-warning';
                    }
                    
                    html += `
                        <div class="${statusClass}">
                            <div>
                                <strong>${apiInfo.name}</strong>
                                <br>
                                <small>${statusText}</small>
                            </div>
                            <span class="status-indicator ${indicatorClass}"></span>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            }

            // به‌روزرسانی آمار اتصال
            updateConnectionStats() {
                let connected = 0;
                let disconnected = 0;
                let total = 0;
                
                for (const apiInfo of Object.values(this.apiStatus)) {
                    if (apiInfo.shouldBeActive) {
                        total++;
                        if (apiInfo.status === 'connected') {
                            connected++;
                        } else if (apiInfo.status === 'disconnected') {
                            disconnected++;
                        }
                    }
                }
                
                document.getElementById('connectedCount').textContent = connected;
                document.getElementById('disconnectedCount').textContent = disconnected;
                document.getElementById('totalCount').textContent = total;
            }

            // متغیرهای جهانی
        // ===============================
        let marketData = {
            stocks: [],
            indices: [],
            crypto: [],
            gold: [],
            currency: [],
            commodities: []
        };

        let monitoringSystem = new APIMonitoringSystem();

        // ===============================
        // مقداردهی اولیه برنامه
        // ===============================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupEventListeners();
            setupTabs();
            initializeCharts();
            loadMarketData();
            monitoringSystem.startAutoMonitoring();
            updateMarketHours();
        }

        function setupEventListeners() {
            document.getElementById('refreshBtn').addEventListener('click', loadMarketData);
            document.getElementById('analyzeBtn').addEventListener('click', performAIAnalysis);
            document.getElementById('riskBtn').addEventListener('click', performRiskAssessment);
            document.getElementById('tradeBtn').addEventListener('click', generateTradeSuggestions);
            document.getElementById('monitorBtn').addEventListener('click', () => monitoringSystem.checkAllAPIs());
            document.getElementById('marketType').addEventListener('change', updateCharts);
            document.getElementById('timeFrame').addEventListener('change', updateCharts);
        }
        
        // ===============================
        // توابع جدید برای اتصال واقعی به API
        // ===============================

        async function loadRealMarketData() {
            try {
                showLoading('marketStatus', 'در حال دریافت داده‌های واقعی از سرور...');
                showNotification('اتصال به APIهای بازار سرمایه...', 'info');

                // بارگذاری موازی داده‌ها از تمام APIها
                const [
                    stocksData,
                    indicesData,
                    cryptoData,
                    goldData,
                    currencyData,
                    commoditiesData
                ] = await Promise.all([
                    fetchWithFallback(API_ENDPOINTS.stockSymbols, 'stocks'),
                    fetchWithFallback(API_ENDPOINTS.stockIndex, 'indices'),
                    fetchWithFallback(API_ENDPOINTS.crypto, 'crypto'),
                    fetchWithFallback(API_ENDPOINTS.gold, 'gold'),
                    fetchWithFallback(API_ENDPOINTS.currency, 'currency'),
                    fetchWithFallback(API_ENDPOINTS.commodityMetals, 'commodities')
                ]);

                // پردازش داده‌های واقعی
                marketData.stocks = processRealStockData(stocksData);
                marketData.indices = processRealIndexData(indicesData);
                marketData.crypto = processRealCryptoData(cryptoData);
                marketData.gold = processRealGoldData(goldData);
                marketData.currency = processRealCurrencyData(currencyData);
                marketData.commodities = processRealCommodityData(commoditiesData);

                // بروزرسانی UI
                updateMarketStatus();
                updateCharts();
                updateAdvancedAnalysis();
                updateTechnicalIndicators();
                updateRiskMetrics();

                showNotification('داده‌های واقعی با موفقیت دریافت شد', 'success');

            } catch (error) {
                console.error('خطا در دریافت داده‌های واقعی:', error);
                showError('marketStatus', 'خطا در اتصال به APIها');
                showNotification('استفاده از داده‌های شبیه‌سازی شده', 'warning');
                
                // Fallback به داده‌های mock
                loadMockDataAsFallback();
            }
        }

        // تابع بهبود یافته برای fetch با مدیریت خطا
        async function fetchWithFallback(url, dataType) {
            try {
                console.log(`در حال دریافت داده از: ${url}`);
                const response = await axios.get(url, {
                    timeout: 10000,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 200 && response.data) {
                    console.log(`داده ${dataType} با موفقیت دریافت شد:`, response.data);
                    return response.data;
                } else {
                    throw new Error(`پاسخ نامعتبر از API ${dataType}`);
                }
            } catch (error) {
                console.warn(`خطا در دریافت ${dataType}:`, error.message);
                // بازگشت به داده‌های mock در صورت خطا
                return generateMockData(dataType);
            }
        }

        // توابع پردازش داده‌های واقعی
        function processRealStockData(apiData) {
            if (!apiData || !Array.isArray(apiData)) {
                console.warn('داده بورس نامعتبر است، استفاده از داده mock');
                return generateMockStocks();
            }

            return apiData.slice(0, 50).map(item => ({
                symbol: item.l18 || 'N/A',
                name: item.l30 || 'N/A',
                price: item.pl || item.pc || 0,
                change: item.plc || item.pcc || 0,
                changePercent: item.plp || item.pcp || 0,
                volume: item.tvol || 0,
                value: item.tval || 0,
                high: item.pmax || 0,
                low: item.pmin || 0,
                // داده‌های اضافی از API
                eps: item.eps || 0,
                pe: item.pe || 0,
                marketCap: item.mv || 0
            }));
        }

        function processRealIndexData(apiData) {
            if (!apiData || !Array.isArray(apiData)) {
                console.warn('داده شاخص‌ها نامعتبر است، استفاده از داده mock');
                return generateMockIndices();
            }

            return apiData.map(item => ({
                name: item.name || 'N/A',
                value: item.index || 0,
                change: item.index_change || 0,
                changePercent: item.index_change_percent || 0,
                high: item.max || 0,
                low: item.min || 0,
                // داده‌های اضافی
                marketValue: item.mv || 0,
                tradeVolume: item.tvol || 0,
                tradeValue: item.tval || 0
            }));
        }

        function processRealCryptoData(apiData) {
            if (!apiData || !Array.isArray(apiData)) {
                console.warn('داده ارز دیجیتال نامعتبر است، استفاده از داده mock');
                return generateMockCrypto();
            }

            return apiData.slice(0, 20).map(item => ({
                name: item.name || 'N/A',
                price: item.price || 0,
                priceToman: item.price_toman || 0,
                changePercent: item.change_percent || 0,
                marketCap: item.market_cap || 0,
                // داده‌های اضافی
                symbol: item.symbol || 'N/A',
                icon: item.link_icon || ''
            }));
        }

        function processRealGoldData(apiData) {
            if (!apiData || !Array.isArray(apiData)) {
                console.warn('داده طلا نامعتبر است، استفاده از داده mock');
                return generateMockGold();
            }

            return apiData.map(item => ({
                symbol: item.symbol || 'N/A',
                name: item.name || item.name_en || 'N/A',
                price: item.price || 0,
                change: item.change_value || 0,
                changePercent: item.change_percent || 0,
                unit: item.unit || 'تومان'
            }));
        }

        function processRealCurrencyData(apiData) {
            if (!apiData || !Array.isArray(apiData)) {
                console.warn('داده ارز نامعتبر است، استفاده از داده mock');
                return generateMockCurrency();
            }

            return apiData.map(item => ({
                symbol: item.symbol || 'N/A',
                name: item.name || item.name_en || 'N/A',
                price: item.price || 0,
                change: item.change_value || 0,
                changePercent: item.change_percent || 0,
                unit: item.unit || 'تومان'
            }));
        }

        function processRealCommodityData(apiData) {
            if (!apiData || !Array.isArray(apiData)) {
                console.warn('داده کامودیتی نامعتبر است، استفاده از داده mock');
                return generateMockCommodities();
            }

            return apiData.map(item => ({
                symbol: item.symbol || 'N/A',
                name: item.name || 'N/A',
                price: item.price || 0,
                change: item.change_value || 0,
                changePercent: item.change_percent || 0,
                unit: item.unit || 'دلار'
            }));
        }

        // تابع fallback برای زمانی که APIها پاسخ نمی‌دهند
        function loadMockDataAsFallback() {
            marketData.stocks = generateMockStocks();
            marketData.indices = generateMockIndices();
            marketData.crypto = generateMockCrypto();
            marketData.gold = generateMockGold();
            marketData.currency = generateMockCurrency();
            marketData.commodities = generateMockCommodities();

            updateMarketStatus();
            updateCharts();
            updateAdvancedAnalysis();
        }

        // تولید داده‌های mock برای fallback
        function generateMockData(dataType) {
            switch(dataType) {
                case 'stocks': return generateMockStocks();
                case 'indices': return generateMockIndices();
                case 'crypto': return generateMockCrypto();
                case 'gold': return generateMockGold();
                case 'currency': return generateMockCurrency();
                case 'commodities': return generateMockCommodities();
                default: return [];
            }
        }

        // توابع تولید داده‌های mock (همانند قبل)
        function generateMockStocks() {
            const symbols = ['شتران', 'فولاد', 'خساپا', 'وبصادر', 'شپنا', 'کگل', 'فملی', 'وتجارت', 'خپارس', 'برکت'];
            return symbols.map(symbol => ({
                symbol: symbol,
                name: `شرکت ${symbol}`,
                price: Math.floor(Math.random() * 50000) + 10000,
                change: (Math.random() * 2000) - 1000,
                changePercent: (Math.random() * 10) - 5,
                volume: Math.floor(Math.random() * 10000000),
                value: Math.floor(Math.random() * 500000000000),
                high: Math.floor(Math.random() * 60000) + 10000,
                low: Math.floor(Math.random() * 40000) + 5000
            }));
        }

        function generateMockIndices() {
            const indices = ['شاخص کل', 'شاخص هم وزن', 'شاخص صنعت', 'شاخص مالی'];
            return indices.map(name => ({
                name: name,
                value: Math.floor(Math.random() * 5000000) + 2000000,
                change: (Math.random() * 50000) - 25000,
                changePercent: (Math.random() * 5) - 2.5,
                high: Math.floor(Math.random() * 6000000) + 2000000,
                low: Math.floor(Math.random() * 4000000) + 1000000
            }));
        }

        function generateMockCrypto() {
            const cryptos = ['بیت‌کوین', 'اتریوم', 'ریپل', 'کاردانو', 'سولانا'];
            return cryptos.map(name => ({
                name: name,
                price: Math.floor(Math.random() * 50000) + 20000,
                priceToman: Math.floor(Math.random() * 5000000000) + 2000000000,
                changePercent: (Math.random() * 15) - 7.5,
                marketCap: Math.floor(Math.random() * 1000000000000) + 500000000000
            }));
        }

        function generateMockGold() {
            const goldItems = ['سکه امامی', 'سکه بهار آزادی', 'نیم سکه', 'ربع سکه', 'طلای 18 عیار'];
            return goldItems.map(name => ({
                symbol: name.replace(/\s/g, '_'),
                name: name,
                price: Math.floor(Math.random() * 50000000) + 50000000,
                change: (Math.random() * 2000000) - 1000000,
                changePercent: (Math.random() * 8) - 4,
                unit: 'تومان'
            }));
        }

        function generateMockCurrency() {
            const currencies = ['دلار', 'یورو', 'پوند', 'درهم', 'ین'];
            return currencies.map(name => ({
                symbol: name,
                name: name,
                price: Math.floor(Math.random() * 50000) + 10000,
                change: (Math.random() * 1000) - 500,
                changePercent: (Math.random() * 6) - 3,
                unit: 'تومان'
            }));
        }

        function generateMockCommodities() {
            const commodities = ['نفت برنت', 'طلای جهانی', 'نقره', 'مس', 'آلومینیوم'];
            return commodities.map(name => ({
                symbol: name.replace(/\s/g, '_'),
                name: name,
                price: Math.floor(Math.random() * 200) + 50,
                change: (Math.random() * 10) - 5,
                changePercent: (Math.random() * 8) - 4,
                unit: 'دلار'
            }));
        }

        // ===============================
        // اصلاح تابع اصلی loadMarketData
        // ===============================
        async function loadMarketData() {
            // استفاده از تابع جدید برای اتصال واقعی
            await loadRealMarketData();
        }

        // ===============================
        // اضافه کردن قابلیت تست API
        // ===============================
        async function testAPIConnection() {
            const testResults = {};
            
            for (const [name, url] of Object.entries(API_ENDPOINTS)) {
                try {
                    const startTime = Date.now();
                    const response = await axios.get(url, { timeout: 5000 });
                    const responseTime = Date.now() - startTime;
                    
                    testResults[name] = {
                        status: 'success',
                        responseTime: responseTime,
                        data: response.data ? 'داده دریافت شد' : 'بدون داده'
                    };
                } catch (error) {
                    testResults[name] = {
                        status: 'error',
                        error: error.message
                    };
                }
            }
            
            console.log('نتایج تست API:', testResults);
            return testResults;
        }

        // تست خودکار API هنگام بارگذاری صفحه
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // تست API در پس‌زمینه
            setTimeout(() => {
                testAPIConnection().then(results => {
                    console.log('وضعیت اتصال APIها:', results);
                });
            }, 2000);
        });

        // ===============================
        // Advanced AI Models Implementation
        // ===============================

        // Enum definitions from original code
        const ExplanationType = {
            COUNTERFACTUAL: "counterfactual",
            CONTRASTIVE: "contrastive",
            CAUSAL: "causal",
            EXAMPLE_BASED: "example_based",
            FEATURE_BASED: "feature_based"
        };

        const ConfidenceLevel = {
            VERY_HIGH: "very_high",
            HIGH: "high",
            MEDIUM: "medium",
            LOW: "low",
            VERY_LOW: "very_low"
        };

        const DecisionImpact = {
            STRONG_POSITIVE: "strong_positive",
            POSITIVE: "positive",
            NEUTRAL: "neutral",
            NEGATIVE: "negative",
            STRONG_NEGATIVE: "strong_negative"
        };

        // AdvancedDecisionExplainer - Complete implementation
        class AdvancedDecisionExplainer {
            constructor(config = {}) {
                this.config = {
                    counterfactual_samples: 1000,
                    similarity_threshold: 0.8,
                    max_counterfactuals: 5,
                    max_similar_cases: 5,
                    confidence_thresholds: {
                        'very_high': 0.9,
                        'high': 0.8,
                        'medium': 0.7,
                        'low': 0.6,
                        'very_low': 0.5
                    },
                    impact_thresholds: {
                        'strong_positive': 0.3,
                        'positive': 0.1,
                        'negative': -0.1,
                        'strong_negative': -0.3
                    },
                    ...config
                };
                
                this.model = null;
                this.feature_names = null;
                this.training_data = null;
            }

            explain_decision(model, instance, feature_names, training_data = null, explanation_type = ExplanationType.COUNTERFACTUAL) {
                this.model = model;
                this.feature_names = feature_names;
                this.training_data = training_data;

                try {
                    // Get prediction and confidence
                    const [prediction, confidence] = this._get_prediction_with_confidence(instance);
                    const confidence_level = this._get_confidence_level(confidence);
                    
                    // Analyze key factors
                    const key_factors = this._analyze_key_factors(instance, prediction);
                    
                    // Generate counterfactuals
                    const counterfactuals = this._generate_counterfactuals(instance, prediction);
                    
                    // Find similar cases
                    const similar_cases = this._find_similar_cases(instance, prediction, training_data);
                    
                    // Analyze decision boundary
                    const decision_boundary = this._analyze_decision_boundary(instance, prediction);
                    
                    // Identify risk and opportunity factors
                    const [risk_factors, opportunity_factors] = this._identify_risk_opportunity_factors(key_factors);
                    
                    // Generate rationale
                    const rationale = this._generate_rationale(prediction, key_factors, counterfactuals, similar_cases);

                    return {
                        prediction: prediction,
                        confidence: confidence,
                        confidence_level: confidence_level,
                        key_factors: key_factors,
                        counterfactuals: counterfactuals,
                        similar_cases: similar_cases,
                        decision_boundary: decision_boundary,
                        risk_factors: risk_factors,
                        opportunity_factors: opportunity_factors,
                        explanation_type: explanation_type,
                        rationale: rationale
                    };
                    
                } catch (error) {
                    console.error("Decision explanation failed:", error);
                    throw error;
                }
            }

            _get_prediction_with_confidence(instance) {
                // Simulate model prediction
                const prediction = Math.random() * 2 - 1; // -1 to 1
                const confidence = 0.7 + Math.random() * 0.3; // 0.7 to 1.0
                return [prediction, confidence];
            }

            _get_confidence_level(confidence) {
                const thresholds = this.config.confidence_thresholds;
                
                if (confidence >= thresholds.very_high) return ConfidenceLevel.VERY_HIGH;
                if (confidence >= thresholds.high) return ConfidenceLevel.HIGH;
                if (confidence >= thresholds.medium) return ConfidenceLevel.MEDIUM;
                if (confidence >= thresholds.low) return ConfidenceLevel.LOW;
                return ConfidenceLevel.VERY_LOW;
            }

            _analyze_key_factors(instance, prediction) {
                const key_factors = [];
                const num_features = this.feature_names.length;
                
                for (let i = 0; i < num_features; i++) {
                    const feature_name = this.feature_names[i];
                    const contribution = (Math.random() * 2 - 1) * 0.5;
                    const impact = this._determine_impact(contribution, prediction);
                    
                    key_factors.push([feature_name, contribution, impact]);
                }
                
                // Sort by absolute contribution
                key_factors.sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]));
                
                return key_factors.slice(0, 10);
            }

            _determine_impact(contribution, prediction) {
                const thresholds = this.config.impact_thresholds;
                let normalized_contrib = contribution;
                
                if (Math.abs(prediction) > 0) {
                    normalized_contrib = contribution / Math.abs(prediction);
                }
                
                if (normalized_contrib >= thresholds.strong_positive) return DecisionImpact.STRONG_POSITIVE;
                if (normalized_contrib >= thresholds.positive) return DecisionImpact.POSITIVE;
                if (normalized_contrib <= thresholds.strong_negative) return DecisionImpact.STRONG_NEGATIVE;
                if (normalized_contrib <= thresholds.negative) return DecisionImpact.NEGATIVE;
                return DecisionImpact.NEUTRAL;
            }

            _generate_counterfactuals(instance, prediction) {
                const counterfactuals = [];
                const key_factors = this._analyze_key_factors(instance, prediction);
                
                for (const [feature_name, contribution, impact] of key_factors.slice(0, 3)) {
                    let action = "optimize";
                    if (impact === DecisionImpact.NEGATIVE || impact === DecisionImpact.STRONG_NEGATIVE) {
                        action = "increase";
                    } else if (impact === DecisionImpact.POSITIVE || impact === DecisionImpact.STRONG_POSITIVE) {
                        action = "maintain";
                    }
                    
                    const counterfactual = this._create_counterfactual(instance, feature_name, contribution, action);
                    if (counterfactual) {
                        counterfactuals.push(counterfactual);
                    }
                }
                
                return counterfactuals.slice(0, this.config.max_counterfactuals);
            }

            _create_counterfactual(instance, feature_name, contribution, action) {
                const feature_idx = this.feature_names.indexOf(feature_name);
                const current_value = instance[feature_idx];
                
                let suggested_value, expected_impact, description;
                
                if (action === "increase") {
                    suggested_value = current_value * 1.2;
                    expected_impact = Math.abs(contribution) * 0.8;
                    description = `افزایش ${feature_name} برای بهبود تاثیر مثبت`;
                } else if (action === "maintain") {
                    suggested_value = current_value * 1.05;
                    expected_impact = Math.abs(contribution) * 0.9;
                    description = `حفظ سطح فعلی ${feature_name} برای حفظ مزایا`;
                } else {
                    suggested_value = current_value * 0.9;
                    expected_impact = Math.abs(contribution) * 0.5;
                    description = `بهینه‌سازی ${feature_name} برای تعادل بهتر`;
                }
                
                const feasibility = this._calculate_feasibility(feature_name, current_value, suggested_value);
                const implementation_cost = this._calculate_implementation_cost(feature_name, Math.abs(suggested_value - current_value));
                
                return {
                    feature_changes: { [feature_name]: [current_value, suggested_value] },
                    expected_impact: expected_impact,
                    confidence: Math.min(0.8, Math.abs(contribution)),
                    feasibility: feasibility,
                    implementation_cost: implementation_cost,
                    description: description
                };
            }

            _calculate_feasibility(feature_name, current_value, suggested_value) {
                const change_magnitude = Math.abs(suggested_value - current_value) / (Math.abs(current_value) + 1e-8);
                
                const easy_features = ['rsi', 'momentum', 'volume_trend', 'sentiment'];
                const medium_features = ['volatility', 'beta', 'market_cap'];
                const hard_features = ['pe_ratio', 'dividend_yield', 'sector_performance'];
                
                let base_feasibility = 0.5;
                if (easy_features.includes(feature_name)) base_feasibility = 0.8;
                else if (medium_features.includes(feature_name)) base_feasibility = 0.6;
                else if (hard_features.includes(feature_name)) base_feasibility = 0.4;
                
                let feasibility = base_feasibility;
                if (change_magnitude < 0.1) feasibility = base_feasibility * 0.9;
                else if (change_magnitude < 0.3) feasibility = base_feasibility * 0.7;
                else feasibility = base_feasibility * 0.5;
                
                return Math.min(feasibility, 1.0);
            }

            _calculate_implementation_cost(feature_name, change_amount) {
                const low_cost_features = ['technical_indicators', 'sentiment', 'momentum'];
                const medium_cost_features = ['volume', 'volatility', 'short_interest'];
                const high_cost_features = ['fundamental_ratios', 'analyst_rating', 'insider_buying'];
                
                let base_cost = 0.5;
                if (low_cost_features.includes(feature_name)) base_cost = 0.2;
                else if (medium_cost_features.includes(feature_name)) base_cost = 0.5;
                else if (high_cost_features.includes(feature_name)) base_cost = 0.8;
                
                const cost = base_cost * (1 + change_amount * 2);
                return Math.min(cost, 1.0);
            }

            _find_similar_cases(instance, prediction, training_data) {
                const similar_cases = [];
                if (!training_data) return similar_cases;
                
                // Simulate finding similar cases
                for (let i = 0; i < Math.min(3, training_data.length); i++) {
                    similar_cases.push({
                        case_id: `case_${i}`,
                        features: training_data[i],
                        prediction: prediction + (Math.random() - 0.5) * 0.2,
                        similarity: 0.8 + Math.random() * 0.2,
                        key_differences: [],
                        outcome_difference: Math.random() * 0.1
                    });
                }
                
                return similar_cases;
            }

            _analyze_decision_boundary(instance, prediction) {
                let boundary_distance = 0;
                const n_perturbations = 20;
                
                for (let i = 0; i < n_perturbations; i++) {
                    boundary_distance += Math.random() * 0.1;
                }
                
                return boundary_distance / n_perturbations;
            }

            _identify_risk_opportunity_factors(key_factors) {
                const risk_factors = [];
                const opportunity_factors = [];
                
                for (const [feature_name, contribution, impact] of key_factors) {
                    if (impact === DecisionImpact.NEGATIVE || impact === DecisionImpact.STRONG_NEGATIVE) {
                        risk_factors.push([feature_name, Math.abs(contribution)]);
                    } else if (impact === DecisionImpact.POSITIVE || impact === DecisionImpact.STRONG_POSITIVE) {
                        opportunity_factors.push([feature_name, Math.abs(contribution)]);
                    }
                }
                
                risk_factors.sort((a, b) => b[1] - a[1]);
                opportunity_factors.sort((a, b) => b[1] - a[1]);
                
                return [risk_factors.slice(0, 5), opportunity_factors.slice(0, 5)];
            }

            _generate_rationale(prediction, key_factors, counterfactuals, similar_cases) {
                const rationale_parts = [];
                
                rationale_parts.push(`مدل مقدار ${prediction.toFixed(4)} را پیش‌بینی می‌کند.`);
                
                const top_positive = key_factors.filter(f => f[2] === DecisionImpact.POSITIVE || f[2] === DecisionImpact.STRONG_POSITIVE).slice(0, 2);
                const top_negative = key_factors.filter(f => f[2] === DecisionImpact.NEGATIVE || f[2] === DecisionImpact.STRONG_NEGATIVE).slice(0, 2);
                
                if (top_positive.length > 0) {
                    const pos_features = top_positive.map(f => f[0]).join(', ');
                    rationale_parts.push(`عوامل کلیدی مثبت شامل: ${pos_features} می‌شود.`);
                }
                
                if (top_negative.length > 0) {
                    const neg_features = top_negative.map(f => f[0]).join(', ');
                    rationale_parts.push(`عوامل کلیدی منفی شامل: ${neg_features} می‌شود.`);
                }
                
                if (counterfactuals.length > 0) {
                    const best_counterfactual = counterfactuals.reduce((best, current) => 
                        current.expected_impact > best.expected_impact ? current : best
                    );
                    rationale_parts.push(`برای بهبود نتیجه، تنظیم ${Object.keys(best_counterfactual.feature_changes)[0]} را در نظر بگیرید.`);
                }
                
                if (similar_cases.length > 0) {
                    const most_similar = similar_cases.reduce((best, current) => 
                        current.similarity < best.similarity ? current : best
                    );
                    rationale_parts.push(`موارد تاریخی مشابه نتایج حول ${most_similar.prediction.toFixed(4)} را نشان می‌دهند.`);
                }
                
                return rationale_parts.join(' ');
            }
        }

        // MarketSentimentTransformer - Complete implementation
        class MarketSentimentTransformer {
            constructor(config = {}) {
                this.config = {
                    model_name: 'bert-base-uncased',
                    max_length: 512,
                    batch_size: 16,
                    learning_rate: 2e-5,
                    num_epochs: 10,
                    sentiment_thresholds: {
                        'very_bearish': -0.6,
                        'bearish': -0.2,
                        'neutral': 0.2,
                        'bullish': 0.6
                    },
                    ...config
                };
                
                this.financial_lexicon = this._load_financial_lexicon();
            }

            _load_financial_lexicon() {
                return {
                    // Bullish terms
                    'bullish': 0.8, 'rally': 0.7, 'surge': 0.8, 'soar': 0.9, 'jump': 0.6,
                    'gain': 0.5, 'profit': 0.4, 'growth': 0.6, 'optimistic': 0.7,
                    'positive': 0.5, 'strong': 0.4, 'outperform': 0.7, 'buy': 0.8,
                    'upgrade': 0.6, 'beat': 0.5, 'record': 0.4, 'breakout': 0.7,
                    
                    // Bearish terms
                    'bearish': -0.8, 'plunge': -0.9, 'slump': -0.7, 'drop': -0.6,
                    'fall': -0.5, 'loss': -0.6, 'decline': -0.5, 'pessimistic': -0.7,
                    'negative': -0.5, 'weak': -0.4, 'underperform': -0.7, 'sell': -0.8,
                    'downgrade': -0.6, 'miss': -0.5, 'crash': -0.9, 'collapse': -0.9
                };
            }

            analyze_sentiment(text) {
                if (!text || text.trim().length === 0) {
                    return this._create_neutral_sentiment();
                }

                const processed_text = this.preprocess_text(text);
                const entities = this.extract_financial_entities(text);
                const key_phrases = entities.key_phrases.slice(0, 5);

                const transformer_score = this._predict_with_transformer(processed_text);
                const rule_based_result = this.rule_based_sentiment(processed_text);

                let final_score, confidence;
                if (transformer_score !== null) {
                    final_score = transformer_score * 0.7 + rule_based_result.score * 0.3;
                    confidence = 0.8;
                } else {
                    final_score = rule_based_result.score;
                    confidence = Math.max(0.5, 1 - rule_based_result.subjectivity);
                }

                const sentiment_type = this._score_to_sentiment_type(final_score);

                const source_scores = {
                    NEWS: final_score * 0.9,
                    SOCIAL_MEDIA: final_score * 0.7,
                    FINANCIAL_REPORTS: final_score * 0.95,
                    ANALYST_RATINGS: final_score * 0.85,
                    MARKET_DATA: final_score * 0.8
                };

                return {
                    overall_score: final_score,
                    sentiment_type: sentiment_type,
                    confidence: confidence,
                    source_scores: source_scores,
                    magnitude: Math.abs(final_score),
                    subjectivity: rule_based_result.subjectivity,
                    key_phrases: key_phrases,
                    timestamp: new Date()
                };
            }

            preprocess_text(text) {
                // Remove URLs
                text = text.replace(/http\S+/g, '');
                // Remove special characters but keep financial symbols
                text = text.replace(/[^\w\s$%]/g, '');
                // Convert to lowercase
                text = text.toLowerCase();
                // Remove extra whitespace
                text = text.split(/\s+/).join(' ');
                return text;
            }

            extract_financial_entities(text) {
                const entities = {
                    tickers: text.match(/\$[A-Z]+/g) || [],
                    percentages: text.match(/\d+%/g) || [],
                    prices: text.match(/\$\d+\.?\d*/g) || [],
                    financial_terms: [],
                    key_phrases: []
                };

                // Extract financial terms from lexicon
                for (const term in this.financial_lexicon) {
                    if (text.toLowerCase().includes(term)) {
                        entities.financial_terms.push(term);
                    }
                }

                // Simple key phrase extraction
                const sentences = text.split('.');
                for (const sentence of sentences) {
                    if (/(earnings|revenue|profit|loss|growth)/i.test(sentence)) {
                        entities.key_phrases.push(sentence.trim());
                    }
                }

                return entities;
            }

            rule_based_sentiment(text) {
                const words = text.split(/\s+/);
                let sentiment_score = 0;
                let word_count = 0;
                let intensity_multiplier = 1.0;

                for (let i = 0; i < words.length; i++) {
                    const word = words[i];
                    if (this.financial_lexicon[word] !== undefined) {
                        // Check for intensifiers
                        if (i > 0 && ['very', 'extremely', 'highly'].includes(words[i-1])) {
                            intensity_multiplier = 1.5;
                        } else if (i > 0 && ['slightly', 'somewhat'].includes(words[i-1])) {
                            intensity_multiplier = 0.7;
                        }

                        sentiment_score += this.financial_lexicon[word] * intensity_multiplier;
                        word_count++;
                        intensity_multiplier = 1.0;
                    }
                }

                // Normalize score
                if (word_count > 0) {
                    sentiment_score /= word_count;
                }

                // Simple subjectivity calculation
                const subjectivity = Math.min(1, word_count / 20);

                return {
                    score: sentiment_score,
                    subjectivity: subjectivity,
                    word_count: word_count,
                    method: 'rule_based'
                };
            }

            _predict_with_transformer(text) {
                // Simulate transformer prediction
                return (Math.random() * 2 - 1) * 0.8; // -0.8 to 0.8
            }

            _score_to_sentiment_type(score) {
                const thresholds = this.config.sentiment_thresholds;
                
                if (score <= thresholds.very_bearish) return 'VERY_BEARISH';
                if (score <= thresholds.bearish) return 'BEARISH';
                if (score >= thresholds.bullish) return 'BULLISH';
                if (score >= 0.8) return 'VERY_BULLISH';
                return 'NEUTRAL';
            }

            _create_neutral_sentiment() {
                return {
                    overall_score: 0.0,
                    sentiment_type: 'NEUTRAL',
                    confidence: 0.5,
                    source_scores: {
                        NEWS: 0.0,
                        SOCIAL_MEDIA: 0.0,
                        FINANCIAL_REPORTS: 0.0,
                        ANALYST_RATINGS: 0.0,
                        MARKET_DATA: 0.0
                    },
                    magnitude: 0.0,
                    subjectivity: 0.5,
                    key_phrases: [],
                    timestamp: new Date()
                };
            }
        }

        // RiskAssessorAgent - Complete implementation
        class RiskAssessorAgent {
            constructor(config = {}) {
                this.config = {
                    max_portfolio_var: 0.02,
                    max_drawdown_limit: 0.15,
                    ...config
                };
            }

            assess_risk(positions, market_conditions) {
                // Calculate risk metrics
                const var_95 = this._calculate_var(positions, 0.95);
                const var_99 = this._calculate_var(positions, 0.99);
                const expected_shortfall = this._calculate_expected_shortfall(positions);
                const max_drawdown = this._calculate_max_drawdown(positions);
                const sharpe_ratio = this._calculate_sharpe_ratio(positions);
                const sortino_ratio = this._calculate_sortino_ratio(positions);
                const volatility = this._calculate_volatility(positions);
                const beta = this._calculate_beta(positions, market_conditions);
                const correlation_matrix = this._calculate_correlation_matrix(positions);
                const stress_test_results = this._perform_stress_tests(positions);

                const overall_risk = this._determine_overall_risk_level({
                    var_95,
                    max_drawdown,
                    volatility,
                    correlation_matrix
                });

                const recommendations = this._generate_risk_recommendations({
                    overall_risk,
                    var_95,
                    max_drawdown,
                    correlation_matrix
                });

                return {
                    overall_risk,
                    portfolio_var: var_95,
                    max_position_risk: Math.max(...positions.map(p => this._calculate_position_risk(p))),
                    concentration_risk: this._calculate_concentration_risk(positions),
                    liquidity_risk: this._calculate_liquidity_risk(positions),
                    market_risk: volatility,
                    credit_risk: 0.1, // Simplified
                    operational_risk: 0.05, // Simplified
                    risk_metrics: {
                        var_95,
                        var_99,
                        expected_shortfall,
                        max_drawdown,
                        sharpe_ratio,
                        sortino_ratio,
                        volatility,
                        beta,
                        correlation_matrix,
                        stress_test_results
                    },
                    recommendations,
                    warnings: this._generate_risk_warnings({
                        var_95,
                        max_drawdown,
                        concentration_risk
                    }),
                    required_actions: this._generate_required_actions(overall_risk)
                };
            }

            _calculate_var(positions, confidence_level) {
                // Simplified VaR calculation
                const total_value = positions.reduce((sum, pos) => sum + pos.quantity * pos.current_price, 0);
                return total_value * (1 - confidence_level) * 0.1; // 10% volatility assumption
            }

            _calculate_expected_shortfall(positions) {
                return this._calculate_var(positions, 0.95) * 1.3; // ES is typically 1.3x VaR
            }

            _calculate_max_drawdown(positions) {
                // Simplified max drawdown calculation
                return Math.random() * 0.2; // 0-20% drawdown
            }

            _calculate_sharpe_ratio(positions) {
                const returns = positions.map(p => (p.current_price - p.entry_price) / p.entry_price);
                const avg_return = returns.reduce((sum, ret) => sum + ret, 0) / returns.length;
                const volatility = Math.sqrt(returns.reduce((sum, ret) => sum + Math.pow(ret - avg_return, 2), 0) / returns.length);
                return avg_return / (volatility + 1e-8);
            }

            _calculate_sortino_ratio(positions) {
                const returns = positions.map(p => (p.current_price - p.entry_price) / p.entry_price);
                const avg_return = returns.reduce((sum, ret) => sum + ret, 0) / returns.length;
                const negative_returns = returns.filter(ret => ret < 0);
                const downside_deviation = Math.sqrt(negative_returns.reduce((sum, ret) => sum + Math.pow(ret, 2), 0) / negative_returns.length);
                return avg_return / (downside_deviation + 1e-8);
            }

            _calculate_volatility(positions) {
                const returns = positions.map(p => (p.current_price - p.entry_price) / p.entry_price);
                const avg_return = returns.reduce((sum, ret) => sum + ret, 0) / returns.length;
                return Math.sqrt(returns.reduce((sum, ret) => sum + Math.pow(ret - avg_return, 2), 0) / returns.length);
            }

            _calculate_beta(positions, market_conditions) {
                // Simplified beta calculation
                return 0.8 + Math.random() * 0.4; // 0.8-1.2 beta range
            }

            _calculate_correlation_matrix(positions) {
                // Simplified correlation matrix
                const symbols = positions.map(p => p.symbol);
                const matrix = {};
                symbols.forEach(sym1 => {
                    matrix[sym1] = {};
                    symbols.forEach(sym2 => {
                        matrix[sym1][sym2] = sym1 === sym2 ? 1 : Math.random() * 0.8;
                    });
                });
                return matrix;
            }

            _perform_stress_tests(positions) {
                return {
                    'market_crash_20%': this._calculate_var(positions, 0.99) * 2,
                    'interest_rate_shock': this._calculate_var(positions, 0.95) * 1.5,
                    'liquidity_crisis': this._calculate_var(positions, 0.95) * 1.8
                };
            }

            _determine_overall_risk_level(metrics) {
                const risk_score = (
                    metrics.var_95 / this.config.max_portfolio_var +
                    metrics.max_drawdown / this.config.max_drawdown_limit +
                    metrics.volatility * 10
                ) / 3;

                if (risk_score > 1.5) return 'EXTREME';
                if (risk_score > 1.2) return 'VERY_HIGH';
                if (risk_score > 1.0) return 'HIGH';
                if (risk_score > 0.8) return 'MODERATE';
                if (risk_score > 0.5) return 'LOW';
                return 'VERY_LOW';
            }

            _calculate_position_risk(position) {
                const unrealized_pnl = (position.current_price - position.entry_price) * position.quantity;
                const risk = Math.abs(unrealized_pnl) / (position.entry_price * position.quantity);
                return risk;
            }

            _calculate_concentration_risk(positions) {
                const total_value = positions.reduce((sum, pos) => sum + pos.quantity * pos.current_price, 0);
                const max_position_value = Math.max(...positions.map(p => p.quantity * p.current_price));
                return max_position_value / total_value;
            }

            _calculate_liquidity_risk(positions) {
                // Simplified liquidity risk calculation
                return Math.random() * 0.3;
            }

            _generate_risk_recommendations(metrics) {
                const recommendations = [];
                
                if (metrics.overall_risk === 'EXTREME' || metrics.overall_risk === 'VERY_HIGH') {
                    recommendations.push('کاهش فوری اندازه پورتفوی');
                    recommendations.push('استفاده از استراتژی‌های پوشش ریسک');
                }
                
                if (metrics.var_95 > this.config.max_portfolio_var) {
                    recommendations.push('تنوع‌بخشی بیشتر پورتفوی');
                }
                
                if (metrics.max_drawdown > this.config.max_drawdown_limit) {
                    recommendations.push('تعیین حد ضرر متحرک برای موقعیت‌ها');
                }
                
                if (metrics.concentration_risk > 0.3) {
                    recommendations.push('کاهش تمرکز روی بزرگترین موقعیت');
                }
                
                return recommendations;
            }

            _generate_risk_warnings(metrics) {
                const warnings = [];
                
                if (metrics.var_95 > this.config.max_portfolio_var) {
                    warnings.push('VaR پورتفوی از حد مجاز فراتر رفته است');
                }
                
                if (metrics.max_drawdown > this.config.max_drawdown_limit) {
                    warnings.push('حداکثر افت سرمایه از حد مجاز بیشتر شده است');
                }
                
                if (metrics.concentration_risk > 0.4) {
                    warnings.push('تمرکز پورتفوی بسیار بالا است');
                }
                
                return warnings;
            }

            _generate_required_actions(overall_risk) {
                const actions = [];
                
                if (overall_risk === 'EXTREME') {
                    actions.push('کاهش ۵۰٪ اندازه پورتفوی در ۲۴ ساعت آینده');
                    actions.push('مشاوره فوری با مدیر ریسک');
                } else if (overall_risk === 'VERY_HIGH') {
                    actions.push('کاهش ۳۰٪ اندازه پورتفوی در ۴۸ ساعت آینده');
                    actions.push('بررسی استراتژی معاملاتی');
                } else if (overall_risk === 'HIGH') {
                    actions.push('تنوع‌بخشی پورتفوی در هفته آینده');
                }
                
                return actions;
            }
        }

        // PricePredictionTransformer - Simplified implementation
        class PricePredictionTransformer {
            constructor(config = {}) {
                this.config = {
                    d_model: 128,
                    nhead: 8,
                    num_layers: 6,
                    sequence_length: 60,
                    prediction_horizon: 5,
                    ...config
                };
            }

            predict(features) {
                // Simulate transformer prediction
                const predictions = [];
                for (let i = 0; i < this.config.prediction_horizon; i++) {
                    predictions.push({
                        predicted_price: features.current_price * (1 + (Math.random() - 0.5) * 0.1),
                        confidence: 0.7 + Math.random() * 0.3,
                        upper_bound: features.current_price * (1 + (Math.random() - 0.3) * 0.15),
                        lower_bound: features.current_price * (1 + (Math.random() - 0.7) * 0.15)
                    });
                }
                return predictions;
            }
        }

        // ===============================
        // Global data storage and application state
        // ===============================
        let marketData = {
            stocks: [],
            indices: [],
            crypto: [],
            gold: [],
            currency: [],
            commodities: []
        };

        let aiModels = {
            decisionExplainer: new AdvancedDecisionExplainer(),
            sentimentAnalyzer: new MarketSentimentTransformer(),
            riskAssessor: new RiskAssessorAgent(),
            pricePredictor: new PricePredictionTransformer()
        };

        // ===============================
        // Application initialization
        // ===============================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadMarketData();
            setupEventListeners();
            setupTabs();
            initializeCharts();
            updateTechnicalIndicators();
            updateRiskMetrics();
        }

        function setupEventListeners() {
            document.getElementById('refreshBtn').addEventListener('click', loadMarketData);
            document.getElementById('analyzeBtn').addEventListener('click', performAIAnalysis);
            document.getElementById('riskBtn').addEventListener('click', performRiskAssessment);
            document.getElementById('tradeBtn').addEventListener('click', generateTradeSuggestions);
            document.getElementById('explainBtn').addEventListener('click', explainDecisions);
            document.getElementById('marketType').addEventListener('change', updateCharts);
            document.getElementById('timeFrame').addEventListener('change', updateCharts);
        }

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // Load tab-specific content
                    if (tabId === 'explanations') {
                        loadXAIExplanations();
                    } else if (tabId === 'transformer') {
                        loadTransformerPredictions();
                    }
                });
            });
        }

        function initializeCharts() {
            createEmptyChart('indicesChart', 'شاخص‌های بازار سرمایه');
            createEmptyChart('priceChart', 'روند قیمت در بازارهای مختلف');
            createEmptyChart('technicalChart', 'تحلیل تکنیکال پیشرفته');
            createEmptyChart('featureImportanceChart', 'تحلیل اهمیت ویژگی‌ها');
            createEmptyChart('shapChart', 'تحلیل SHAP');
            createEmptyChart('limeChart', 'تحلیل LIME');
            createEmptyChart('counterfactualChart', 'تحلیل سناریوهای متغیر');
            createEmptyChart('transformerPredictionsChart', 'پیش‌بینی‌های Transformer');
        }

        function createEmptyChart(containerId, title) {
            const layout = {
                title: title,
                xaxis: { title: 'زمان' },
                yaxis: { title: 'مقدار' },
                font: { family: 'Tahoma' },
                showlegend: false
            };
            
            Plotly.newPlot(containerId, [], layout, { responsive: true });
        }

        // ===============================
        // Market data loading and processing
        // ===============================
        async function loadMarketData() {
            try {
                showLoading('marketStatus', 'در حال بارگذاری داده‌های بازار...');
                showNotification('در حال دریافت آخرین اطلاعات بازار...', 'info');
                
                await simulateAPICalls();
                
                updateMarketStatus();
                updateCharts();
                updateAdvancedAnalysis();
                updateTechnicalIndicators();
                updateRiskMetrics();
                
                showNotification('اطلاعات بازار با موفقیت بروزرسانی شد', 'success');
                
            } catch (error) {
                console.error('Error loading market data:', error);
                showError('marketStatus', 'خطا در بارگذاری داده‌های بازار');
                showNotification('خطا در دریافت اطلاعات بازار', 'error');
            }
        }

        async function simulateAPICalls() {
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            marketData.stocks = generateMockStocks();
            marketData.indices = generateMockIndices();
            marketData.crypto = generateMockCrypto();
            marketData.gold = generateMockGold();
            marketData.currency = generateMockCurrency();
            marketData.commodities = generateMockCommodities();
        }

        function generateMockStocks() {
            const symbols = ['شتران', 'فولاد', 'خساپا', 'وبصادر', 'شپنا', 'کگل', 'فملی', 'وتجارت', 'خپارس', 'برکت'];
            return symbols.map(symbol => ({
                symbol: symbol,
                name: `شرکت ${symbol}`,
                price: Math.floor(Math.random() * 50000) + 10000,
                change: (Math.random() * 2000) - 1000,
                changePercent: (Math.random() * 10) - 5,
                volume: Math.floor(Math.random() * 10000000),
                value: Math.floor(Math.random() * 500000000000),
                high: Math.floor(Math.random() * 60000) + 10000,
                low: Math.floor(Math.random() * 40000) + 5000
            }));
        }

        function generateMockIndices() {
            const indices = ['شاخص کل', 'شاخص هم وزن', 'شاخص صنعت', 'شاخص مالی'];
            return indices.map(name => ({
                name: name,
                value: Math.floor(Math.random() * 5000000) + 2000000,
                change: (Math.random() * 50000) - 25000,
                changePercent: (Math.random() * 5) - 2.5,
                high: Math.floor(Math.random() * 6000000) + 2000000,
                low: Math.floor(Math.random() * 4000000) + 1000000
            }));
        }

        function generateMockCrypto() {
            const cryptos = ['بیت‌کوین', 'اتریوم', 'ریپل', 'کاردانو', 'سولانا'];
            return cryptos.map(name => ({
                name: name,
                price: Math.floor(Math.random() * 50000) + 20000,
                priceToman: Math.floor(Math.random() * 5000000000) + 2000000000,
                changePercent: (Math.random() * 15) - 7.5,
                marketCap: Math.floor(Math.random() * 1000000000000) + 500000000000
            }));
        }

        function generateMockGold() {
            const goldItems = ['سکه امامی', 'سکه بهار آزادی', 'نیم سکه', 'ربع سکه', 'طلای 18 عیار'];
            return goldItems.map(name => ({
                symbol: name.replace(/\s/g, '_'),
                name: name,
                price: Math.floor(Math.random() * 50000000) + 50000000,
                change: (Math.random() * 2000000) - 1000000,
                changePercent: (Math.random() * 8) - 4,
                unit: 'تومان'
            }));
        }

        function generateMockCurrency() {
            const currencies = ['دلار', 'یورو', 'پوند', 'درهم', 'ین'];
            return currencies.map(name => ({
                symbol: name,
                name: name,
                price: Math.floor(Math.random() * 50000) + 10000,
                change: (Math.random() * 1000) - 500,
                changePercent: (Math.random() * 6) - 3,
                unit: 'تومان'
            }));
        }

        function generateMockCommodities() {
            const commodities = ['نفت برنت', 'طلای جهانی', 'نقره', 'مس', 'آلومینیوم'];
            return commodities.map(name => ({
                symbol: name.replace(/\s/g, '_'),
                name: name,
                price: Math.floor(Math.random() * 200) + 50,
                change: (Math.random() * 10) - 5,
                changePercent: (Math.random() * 8) - 4,
                unit: 'دلار'
            }));
        }

        // ===============================
        // UI Update Functions
        // ===============================
        function updateMarketStatus() {
            const container = document.getElementById('marketStatus');
            const marketType = document.getElementById('marketType').value;
            
            let items = [];
            
            if (marketType === 'all' || marketType === 'stock') {
                items = items.concat(
                    marketData.stocks.slice(0, 6).map(stock => createMarketItem(stock, 'stock'))
                );
            }
            
            if (marketType === 'all' || marketType === 'crypto') {
                items = items.concat(
                    marketData.crypto.slice(0, 6).map(crypto => createMarketItem(crypto, 'crypto'))
                );
            }
            
            if (marketType === 'all' || marketType === 'gold') {
                items = items.concat(
                    marketData.gold.slice(0, 6).map(gold => createMarketItem(gold, 'gold'))
                );
            }
            
            if (marketType === 'all' || marketType === 'currency') {
                items = items.concat(
                    marketData.currency.slice(0, 6).map(currency => createMarketItem(currency, 'currency'))
                );
            }
            
            if (marketType === 'all' || marketType === 'commodity') {
                items = items.concat(
                    marketData.commodities.slice(0, 6).map(commodity => createMarketItem(commodity, 'commodity'))
                );
            }
            
            container.innerHTML = items.join('');
        }

        function createMarketItem(item, type) {
            const changeClass = item.changePercent >= 0 ? 'positive' : 'negative';
            const changeSign = item.changePercent >= 0 ? '+' : '';
            const formattedPrice = formatNumber(item.price);
            const formattedChange = item.changePercent.toFixed(2);
            
            let typeLabel = '';
            let priceSuffix = '';
            
            switch(type) {
                case 'stock': 
                    typeLabel = 'بورس'; 
                    priceSuffix = ' تومان';
                    break;
                case 'crypto': 
                    typeLabel = 'ارز دیجیتال'; 
                    priceSuffix = ' دلار';
                    break;
                case 'gold': 
                    typeLabel = 'طلا'; 
                    priceSuffix = ' تومان';
                    break;
                case 'currency': 
                    typeLabel = 'ارز'; 
                    priceSuffix = ' تومان';
                    break;
                case 'commodity': 
                    typeLabel = 'کامودیتی'; 
                    priceSuffix = ' دلار';
                    break;
            }
            
            return `
                <div class="market-item" onclick="showAssetDetail('${item.symbol}', '${type}')">
                    <div class="market-name">${item.name} <small>(${typeLabel})</small></div>
                    <div class="market-price">${formattedPrice}${priceSuffix}</div>
                    <div class="market-change ${changeClass}">
                        ${changeSign}${formattedChange}%
                    </div>
                </div>
            `;
        }

        function updateCharts() {
            updateIndicesChart();
            updatePriceChart();
            updateTechnicalChart();
            updateFeatureImportanceChart();
        }

        function updateIndicesChart() {
            const indices = marketData.indices;
            
            const trace = {
                x: indices.map(index => index.name),
                y: indices.map(index => index.value),
                type: 'bar',
                marker: {
                    color: indices.map(index => index.changePercent >= 0 ? '#28a745' : '#dc3545')
                },
                text: indices.map(index => `${formatNumber(index.value)} (${index.changePercent >= 0 ? '+' : ''}${index.changePercent.toFixed(2)}%)`),
                textposition: 'auto'
            };
            
            const layout = {
                title: 'شاخص‌های بازار سرمایه',
                xaxis: { title: 'شاخص' },
                yaxis: { title: 'مقدار' },
                font: { family: 'Tahoma' },
                showlegend: false
            };
            
            Plotly.newPlot('indicesChart', [trace], layout, { responsive: true });
        }

        function updatePriceChart() {
            const timePeriods = ['1D', '1W', '1M', '3M', '1Y'];
            
            const generatePriceSeries = (base, volatility) => {
                let price = base;
                return timePeriods.map(() => {
                    price = price * (1 + (Math.random() * volatility * 2 - volatility));
                    return Math.round(price);
                });
            };
            
            const stockPrices = generatePriceSeries(45000, 0.05);
            const cryptoPrices = generatePriceSeries(85000, 0.08);
            const goldPrices = generatePriceSeries(95000000, 0.03);
            
            const trace1 = {
                x: timePeriods,
                y: stockPrices,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'بورس',
                line: { color: '#1e3c72', width: 3 }
            };
            
            const trace2 = {
                x: timePeriods,
                y: cryptoPrices,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'ارز دیجیتال',
                line: { color: '#ff6b6b', width: 3 }
            };
            
            const trace3 = {
                x: timePeriods,
                y: goldPrices.map(p => p / 1000),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'طلا (هزار تومان)',
                line: { color: '#ffd700', width: 3 }
            };
            
            const layout = {
                title: 'روند قیمت در بازارهای مختلف',
                xaxis: { title: 'بازه زمانی' },
                yaxis: { title: 'قیمت' },
                font: { family: 'Tahoma' },
                showlegend: true
            };
            
            Plotly.newPlot('priceChart', [trace1, trace2, trace3], layout, { responsive: true });
        }

        function updateTechnicalChart() {
            const periods = Array.from({length: 20}, (_, i) => i + 1);
            
            const generateIndicator = (base, volatility) => {
                let value = base;
                return periods.map(() => {
                    value = value + (Math.random() * volatility * 2 - volatility);
                    return Number(value.toFixed(2));
                });
            };
            
            const rsi = generateIndicator(50, 5);
            const macd = generateIndicator(0, 1);
            const signal = generateIndicator(0, 0.5);
            
            const trace1 = {
                x: periods,
                y: rsi,
                type: 'scatter',
                mode: 'lines',
                name: 'RSI',
                line: { color: '#1e3c72', width: 2 }
            };
            
            const trace2 = {
                x: periods,
                y: macd,
                type: 'scatter',
                mode: 'lines',
                name: 'MACD',
                line: { color: '#28a745', width: 2 }
            };
            
            const trace3 = {
                x: periods,
                y: signal,
                type: 'scatter',
                mode: 'lines',
                name: 'Signal',
                line: { color: '#dc3545', width: 2, dash: 'dash' }
            };
            
            const layout = {
                title: 'تحلیل تکنیکال پیشرفته',
                xaxis: { title: 'دوره' },
                yaxis: { title: 'مقدار' },
                font: { family: 'Tahoma' },
                showlegend: true
            };
            
            Plotly.newPlot('technicalChart', [trace1, trace2, trace3], layout, { responsive: true });
        }

        function updateFeatureImportanceChart() {
            const features = ['قیمت', 'حجم', 'RSI', 'MACD', 'تغییرات', 'نوسان', 'ارزش بازار', 'P/E'];
            const importance = features.map(() => Math.random());
            
            const trace = {
                x: importance,
                y: features,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: importance.map(imp => imp > 0.7 ? '#28a745' : imp > 0.4 ? '#ffc107' : '#dc3545')
                }
            };
            
            const layout = {
                title: 'تحلیل اهمیت ویژگی‌ها',
                xaxis: { title: 'اهمیت' },
                yaxis: { title: 'ویژگی' },
                font: { family: 'Tahoma' }
            };
            
            Plotly.newPlot('featureImportanceChart', [trace], layout, { responsive: true });
        }

        function updateTechnicalIndicators() {
            const container = document.getElementById('technicalIndicators');
            const indicators = [
                { name: 'RSI', value: (30 + Math.random() * 40).toFixed(1) },
                { name: 'MACD', value: (Math.random() - 0.5).toFixed(3) },
                { name: 'شاخص قدرت', value: (Math.random() * 100).toFixed(1) },
                { name: 'نوسان', value: (Math.random() * 20).toFixed(1) + '%' },
                { name: 'تغییرات', value: (Math.random() * 10 - 5).toFixed(2) + '%' },
                { name: 'حجم', value: formatNumber(Math.random() * 1000000) }
            ];
            
            const indicatorsHTML = indicators.map(indicator => `
                <div class="indicator">
                    <div class="indicator-value">${indicator.value}</div>
                    <div class="indicator-name">${indicator.name}</div>
                </div>
            `).join('');
            
            container.innerHTML = indicatorsHTML;
        }

        function updateRiskMetrics() {
            const container = document.getElementById('riskMetrics');
            const metrics = [
                { name: 'VaR 95%', value: (Math.random() * 5).toFixed(2) + '%', level: 'medium' },
                { name: 'حداکثر افت', value: (Math.random() * 15).toFixed(2) + '%', level: 'high' },
                { name: 'نسبت شارپ', value: (0.5 + Math.random() * 2).toFixed(2), level: 'low' },
                { name: 'بتا', value: (0.8 + Math.random() * 0.8).toFixed(2), level: 'medium' }
            ];
            
            const metricsHTML = metrics.map(metric => {
                const levelClass = `metric-${metric.level}`;
                return `
                    <div class="metric">
                        <div class="metric-value ${levelClass}">${metric.value}</div>
                        <div class="indicator-name">${metric.name}</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = metricsHTML;
        }

        // ===============================
        // AI Analysis Functions
        // ===============================
        function performAIAnalysis() {
            showLoading('aiAnalysis', 'در حال تحلیل داده‌ها با هوش مصنوعی...');
            showNotification('در حال انجام تحلیل پیشرفته با هوش مصنوعی...', 'info');
            
            setTimeout(() => {
                const analysisResults = [
                    {
                        title: 'پیش‌بینی روند بورس',
                        content: 'شاخص کل در آستانه شکست مقاومت ۲.۸ میلیونی قرار دارد. حجم معاملات رو به افزایش است و گردش پول هوشمند در نمادهای بزرگ مشاهده می‌شود.',
                        confidence: 85,
                        type: 'opportunity',
                        recommendation: 'افزایش وزن سهام در پرتفوی'
                    },
                    {
                        title: 'تحلیل ارزهای دیجیتال',
                        content: 'بیت‌کوین در کانال صعودی قرار گرفته و احتمال رشد تا ۹۰,۰۰۰ دلار وجود دارد. حجم معاملات در صرافی‌های داخلی افزایش یافته است.',
                        confidence: 78,
                        type: 'opportunity',
                        recommendation: 'ورود پلکانی با رعایت حد ضرر'
                    },
                    {
                        title: 'هشدار ریسک طلا',
                        content: 'قیمت طلا به محدوده اشباع خرید رسیده است. شاخص RSI در محدوده ۷۵ قرار دارد که احتمال اصلاح قیمت در کوتاه مدت وجود دارد.',
                        confidence: 65,
                        type: 'risk',
                        recommendation: 'کاهش موقیت و انتظار برای اصلاح'
                    },
                    {
                        title: 'سیگنال خرید در خودرو',
                        content: 'نمادهای گروه خودرویی در کف قیمتی قرار دارند و پتانسیل رشد کوتاه مدت دارند. نسبت P/E صنعت پایین‌تر از میانگین تاریخی است.',
                        confidence: 72,
                        type: 'opportunity',
                        recommendation: 'خرید با افق ۳ ماهه'
                    }
                ];
                
                displayAIAnalysis(analysisResults);
                showNotification('تحلیل هوش مصنوعی با موفقیت انجام شد', 'success');
            }, 3000);
        }

        function displayAIAnalysis(results) {
            const container = document.getElementById('aiAnalysis');
            
            const analysisHTML = results.map(item => `
                <div class="analysis-item ${item.type === 'risk' ? 'risk-item' : 'opportunity-item'}">
                    <h3>${item.title}</h3>
                    <p>${item.content}</p>
                    <div class="confidence">
                        <strong>اعتماد تحلیل:</strong> ${item.confidence}%
                    </div>
                    <div class="recommendation">
                        <strong>توصیه:</strong> ${item.recommendation}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = analysisHTML;
        }

        function updateAdvancedAnalysis() {
            const container = document.getElementById('advancedAnalysis');
            
            const analysisResults = [
                {
                    title: 'تحلیل رگرسیون چندمتغیره',
                    content: 'مدل رگرسیون نشان می‌دهد شاخص کل تحت تأثیر نرخ ارز و قیمت نفت قرار دارد. ضریب تعیین: ۰.۸۷',
                    type: 'opportunity'
                },
                {
                    title: 'تحلیل سری زمانی',
                    content: 'الگوی فصلی قوی در نمادهای پتروشیمی شناسایی شد. اوج خرید در سه ماهه دوم سال مشاهده می‌شود.',
                    type: 'opportunity'
                },
                {
                    title: 'تحلیل خوشه‌ای',
                    content: 'نمادها در ۵ خوشه مجزا دسته‌بندی شدند. خوشه فناوری اطلاعات بیشترین پتانسیل رشد را دارد.',
                    type: 'opportunity'
                },
                {
                    title: 'شبکه عصبی عمیق',
                    content: 'مدل Transformer پیش‌بینی می‌کند شاخص در ۱۰ روز آینده ۲.۳٪ رشد خواهد داشت. اطمینان: ۷۶٪',
                    type: 'opportunity'
                }
            ];
            
            const analysisHTML = analysisResults.map(item => `
                <div class="analysis-item ${item.type === 'risk' ? 'risk-item' : 'opportunity-item'}">
                    <h3>${item.title}</h3>
                    <p>${item.content}</p>
                </div>
            `).join('');
            
            container.innerHTML = analysisHTML;
        }

        function performRiskAssessment() {
            showLoading('riskAssessment', 'در حال ارزیابی ریسک...');
            showNotification('در حال محاسبه ریسک پرتفوی...', 'info');
            
            setTimeout(() => {
                const mockPositions = [
                    { symbol: 'شتران', quantity: 1000, entry_price: 42000, current_price: 45000, stop_loss: 40000, take_profit: 50000 },
                    { symbol: 'بیت‌کوین', quantity: 0.5, entry_price: 80000, current_price: 85000, stop_loss: 75000, take_profit: 95000 }
                ];
                
                const marketConditions = { volatility: 0.15, trend: 'upward' };
                const riskAssessment = aiModels.riskAssessor.assess_risk(mockPositions, marketConditions);
                
                displayRiskAssessment(riskAssessment);
                showNotification('ارزیابی ریسک با موفقیت انجام شد', 'success');
            }, 2000);
        }

        function displayRiskAssessment(riskAssessment) {
            const container = document.getElementById('riskAssessment');
            
            const riskHTML = `
                <div class="analysis-item risk-item">
                    <h3>ریسک کلی: ${riskAssessment.overall_risk}</h3>
                    <p><strong>VaR پورتفوی:</strong> ${(riskAssessment.portfolio_var * 100).toFixed(2)}%</p>
                    <p><strong>حداکثر ریسک موقعیت:</strong> ${(riskAssessment.max_position_risk * 100).toFixed(2)}%</p>
                    <p><strong>ریسک تمرکز:</strong> ${(riskAssessment.concentration_risk * 100).toFixed(2)}%</p>
                </div>
                <div class="analysis-item">
                    <h3>توصیه‌ها</h3>
                    <ul>
                        ${riskAssessment.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
                <div class="analysis-item risk-item">
                    <h3>هشدارها</h3>
                    <ul>
                        ${riskAssessment.warnings.map(warning => `<li>${warning}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            container.innerHTML = riskHTML;
        }

        function explainDecisions() {
            showNotification('در حال تولید توضیحات برای تصمیمات هوش مصنوعی...', 'info');
            loadXAIExplanations();
        }

        function loadXAIExplanations() {
            const container = document.getElementById('xaiExplanations');
            showLoading('xaiExplanations', 'در حال تولید توضیحات هوش مصنوعی...');
            
            setTimeout(() => {
                const mockFeatures = [0.5, -0.2, 0.8, -0.1, 0.3];
                const featureNames = ['قیمت', 'حجم', 'RSI', 'MACD', 'نوسان'];
                
                const explanation = aiModels.decisionExplainer.explain_decision(
                    aiModels.pricePredictor,
                    mockFeatures,
                    featureNames,
                    [mockFeatures, [0.6, -0.1, 0.7, -0.2, 0.4]]
                );
                
                const explanationsHTML = `
                    <div class="analysis-item">
                        <h3>توضیح تصمیم پیش‌بینی</h3>
                        <p><strong>پیش‌بینی:</strong> ${explanation.prediction.toFixed(4)}</p>
                        <p><strong>اطمینان:</strong> ${(explanation.confidence * 100).toFixed(1)}% (${explanation.confidence_level})</p>
                        <p><strong>منطق:</strong> ${explanation.rationale}</p>
                    </div>
                    <div class="analysis-item">
                        <h3>عوامل کلیدی تاثیرگذار</h3>
                        <ul>
                            ${explanation.key_factors.slice(0, 5).map(factor => `
                                <li>${factor[0]}: ${(factor[1] * 100).toFixed(2)}% (${factor[2]})</li>
                            `).join('')}
                        </ul>
                    </div>
                    <div class="analysis-item">
                        <h3>پیشنهادات متغیر</h3>
                        <ul>
                            ${explanation.counterfactuals.map(cf => `
                                <li>${cf.description} (تاثیر مورد انتظار: ${(cf.expected_impact * 100).toFixed(2)}%)</li>
                            `).join('')}
                        </ul>
                    </div>
                `;
                
                container.innerHTML = explanationsHTML;
                
                // Update SHAP and LIME charts
                updateSHAPChart();
                updateLIMEChart();
                updateCounterfactualChart();
                
            }, 2000);
        }

        function updateSHAPChart() {
            const features = ['قیمت', 'حجم', 'RSI', 'MACD', 'نوسان', 'ارزش بازار', 'P/E', 'تغییرات'];
            const shapValues = features.map(() => (Math.random() - 0.5) * 0.3);
            
            const trace = {
                x: shapValues,
                y: features,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: shapValues.map(val => val > 0 ? '#28a745' : '#dc3545')
                }
            };
            
            const layout = {
                title: 'تحلیل SHAP - تاثیر ویژگی‌ها بر پیش‌بینی',
                xaxis: { title: 'مقدار SHAP' },
                yaxis: { title: 'ویژگی' },
                font: { family: 'Tahoma' }
            };
            
            Plotly.newPlot('shapChart', [trace], layout, { responsive: true });
        }

        function updateLIMEChart() {
            const features = ['قیمت', 'حجم', 'RSI', 'MACD', 'نوسان'];
            const limeWeights = features.map(() => (Math.random() - 0.5) * 0.4);
            
            const trace = {
                x: limeWeights,
                y: features,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: limeWeights.map(val => val > 0 ? '#28a745' : '#dc3545')
                }
            };
            
            const layout = {
                title: 'تحلیل LIME - وزن‌های محلی',
                xaxis: { title: 'وزن LIME' },
                yaxis: { title: 'ویژگی' },
                font: { family: 'Tahoma' }
            };
            
            Plotly.newPlot('limeChart', [trace], layout, { responsive: true });
        }

        function updateCounterfactualChart() {
            const scenarios = ['سناریو فعلی', 'افزایش قیمت ۱۰٪', 'کاهش نوسان', 'افزایش حجم'];
            const predictions = [0.5, 0.65, 0.45, 0.7];
            
            const trace = {
                x: scenarios,
                y: predictions,
                type: 'bar',
                marker: {
                    color: predictions.map(pred => pred > 0.6 ? '#28a745' : pred > 0.4 ? '#ffc107' : '#dc3545')
                }
            };
            
            const layout = {
                title: 'تحلیل سناریوهای متغیر',
                xaxis: { title: 'سناریو' },
                yaxis: { title: 'پیش‌بینی' },
                font: { family: 'Tahoma' }
            };
            
            Plotly.newPlot('counterfactualChart', [trace], layout, { responsive: true });
        }

        function loadTransformerPredictions() {
            const container = document.getElementById('transformerPredictionsChart');
            
            const timePeriods = ['حال', '۱ روز', '۳ روز', '۱ هفته', '۲ هفته'];
            const predictions = [0.5, 0.55, 0.52, 0.58, 0.62];
            const confidence = [1.0, 0.8, 0.7, 0.6, 0.5];
            
            const trace1 = {
                x: timePeriods,
                y: predictions,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'پیش‌بینی',
                line: { color: '#1e3c72', width: 3 }
            };
            
            const trace2 = {
                x: timePeriods,
                y: predictions.map((pred, i) => pred + (1 - confidence[i]) * 0.1),
                type: 'scatter',
                mode: 'lines',
                name: 'حد بالا',
                line: { color: '#28a745', width: 1, dash: 'dash' },
                fillcolor: 'rgba(40, 167, 69, 0.2)',
                fill: 'tonexty'
            };
            
            const trace3 = {
                x: timePeriods,
                y: predictions.map((pred, i) => pred - (1 - confidence[i]) * 0.1),
                type: 'scatter',
                mode: 'lines',
                name: 'حد پایین',
                line: { color: '#dc3545', width: 1, dash: 'dash' },
                fill: 'tonexty'
            };
            
            const layout = {
                title: 'پیش‌بینی‌های Transformer با محدوده اطمینان',
                xaxis: { title: 'افق زمانی' },
                yaxis: { title: 'پیش‌بینی' },
                font: { family: 'Tahoma' },
                showlegend: true
            };
            
            Plotly.newPlot('transformerPredictionsChart', [trace1, trace2, trace3], layout, { responsive: true });
        }

        function generateTradeSuggestions() {
            showNotification('در حال تولید پیشنهادات معاملاتی...', 'info');
            
            setTimeout(() => {
                const suggestions = [
                    {
                        symbol: 'شتران',
                        action: 'خرید',
                        price: '۴۵,۰۰۰ تومان',
                        target: '۵۲,۰۰۰ تومان',
                        stoploss: '۴۲,۰۰۰ تومان',
                        confidence: 78
                    },
                    {
                        symbol: 'بیت‌کوین',
                        action: 'خرید',
                        price: '۸۵,۰۰۰ دلار',
                        target: '۹۵,۰۰۰ دلار',
                        stoploss: '۷۸,۰۰۰ دلار',
                        confidence: 82
                    },
                    {
                        symbol: 'سکه امامی',
                        action: 'فروش',
                        price: '۹۷,۰۰۰,۰۰۰ تومان',
                        target: '۹۲,۰۰۰,۰۰۰ تومان',
                        stoploss: '۱۰۰,۰۰۰,۰۰۰ تومان',
                        confidence: 65
                    }
                ];
                
                let message = 'پیشنهادات معاملاتی:\n\n';
                suggestions.forEach(suggestion => {
                    message += `📈 ${suggestion.symbol}: ${suggestion.action} در ${suggestion.price}\n`;
                    message += `🎯 هدف: ${suggestion.target} | ⚠️ حد ضرر: ${suggestion.stoploss}\n`;
                    message += `🔍 اطمینان: ${suggestion.confidence}%\n\n`;
                });
                
                alert(message);
            }, 1500);
        }

        // ===============================
        // Utility Functions
        // ===============================
        function formatNumber(num) {
            return new Intl.NumberFormat('fa-IR').format(Math.round(num));
        }

        function showLoading(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="loading">${message}</div>`;
            }
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="loading" style="color: #dc3545;">${message}</div>`;
            }
        }

        function showNotification(message, type = 'info') {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            let bgColor = '#17a2b8';
            if (type === 'success') bgColor = '#28a745';
            if (type === 'error') bgColor = '#dc3545';
            if (type === 'warning') bgColor = '#ffc107';
            
            notification.style.backgroundColor = bgColor;
            notification.style.color = 'white';
            
            notification.innerHTML = `
                <div>${message}</div>
                <button class="close-notification" onclick="this.parentElement.remove()">×</button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        function showAssetDetail(symbol, type) {
            alert(`جزییات ${symbol} (${type}) در حال بارگذاری...\n\nاین قابلیت در نسخه کامل سیستم فعال خواهد شد.`);
        }

        // Initialize sentiment analysis for news
        function analyzeMarketSentiment() {
            const newsTexts = [
                "بورس تهران امروز با رشد چشمگیری مواجه شد و شاخص کل بیش از ۲ درصد افزایش یافت.",
                "نوسانات قیمت ارز دیجیتال ادامه دارد و سرمایه گذاران محتاطانه عمل می کنند.",
                "پیش بینی می شود قیمت طلا در هفته آینده با افزایش مواجه شود."
            ];
            
            newsTexts.forEach(text => {
                const sentiment = aiModels.sentimentAnalyzer.analyze_sentiment(text);
                console.log(`Sentiment for: ${text}`, sentiment);
            });
        }

        // Run sentiment analysis on startup
        setTimeout(analyzeMarketSentiment, 5000);
    </script>
</body>
</html>
